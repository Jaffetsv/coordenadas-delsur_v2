<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>B√∫squeda Geogr√°fica</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f4fdf4; }
    header { background: #006699; color: white; padding: 1rem; text-align: center; }
    main { padding: 1rem; }
    select, input[type="text"], input[type="number"], button {
      padding: 0.5rem;
      margin: 0.5rem 0.3rem 0.5rem 0;
      font-size: 1rem;
    }
    #map { height: 500px; margin-top: 1rem; } #inputSection select, #inputSection input, #inputSection button { flex: 1 1 auto; min-width: 150px; }
    .result { margin-top: 1rem; background: #e6f5e6; padding: 1rem; border-radius: 8px; }
  
    @media (max-width: 600px) {
      body, select, input, button {
        font-size: 1.05rem;
      }
      header h1 {
        font-size: 1rem;
      }
      #inputSection {
        flex-direction: column;
        align-items: stretch;
      }
      header img {
        height: 60px;
      }
    }
    @media (max-width: 600px) {
  #manualCoords {
    flex-direction: column;
    align-items: center;
  }
  #tabla-cercanos table {
    font-size: 0.85rem;
  }
}
</style>
</head>
<body>
  <header style='display:flex;justify-content:space-between;align-items:center;'>
    <h1 style='margin: 0 auto; text-align: center;'>B√∫squeda Geogr√°fica Elementos De La Red DELSUR Regi√≥n 3</h1>
    <img src='logo_delsur.webp' alt='Logo Delsur' style='height:90px; margin-right:1rem;'>
  </header>
  <main>
    <label for="searchType">Selecciona tipo de b√∫squeda:</label>
    <select id="searchType" onchange="mostrarOpcionesUbicacion()">
      <option value="placa">Por Placa</option>
      <option value="contrato">Por Contrato</option>
      <option value="ubicacion">Por Ubicaci√≥n</option>
    </select>
    
    <div id="inputSection" style="
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-top: 1rem;
    ">
      <input type="text" id="searchInput" placeholder="Ingrese el elemento a buscar" onkeypress="if(event.key==='Enter'){buscar()}">
      
<div id="manualCoords" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
  <button type="button" onclick="usarUbicacionActual()" style="background:#006699; color:white; padding: 0.5rem 1rem; height: 40px;">üìç Mi Ubicaci√≥n Actual</button>
  <input type="number" id="latInput" placeholder="Latitud" step="any" style="min-width: 120px; height: 40px;">
  <input type="number" id="lonInput" placeholder="Longitud" step="any" style="min-width: 120px; height: 40px;">
</div>

      <button id="botonBuscar" onclick="buscar()" disabled>Buscar</button>
    <button type="button" onclick="limpiarBusqueda()" style="background:#ccc; color:#000; padding: 0.5rem 1rem;">Limpiar</button>
<p id="mensajeCoordenadas" style="color:#b30000; font-weight:bold; display:none;">Si no ingres√≥ su ubicaci√≥n actual debe ingresar las coordenadas manualmente.</p>
    </div>
    <div class="result" id="result"></div>
       <div id="tabla-cercanos" class="result" style="overflow-x:auto;"></div>
    <div id="map"></div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js">
    function centrarEnMapa(lat, lon, placa, alimentador) {
      map.setView([lat, lon], 17);
      const popupText = `<b>${placa}</b><br>${lat}, ${lon}<br>${alimentador}<br>
        <a href='https://www.google.com/maps?q=${lat},${lon}' target='_blank'>üìç Ver en Google Maps</a>`;
      const marker = L.marker([lat, lon]).addTo(markerLayer);
      marker.bindPopup(popupText).openPopup();
    }
    
    function usarUbicacionActual() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          userLocation = [lat, lon];
          L.marker(userLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'})})
            .addTo(markerLayer).bindPopup('Tu ubicaci√≥n').openPopup();
          mostrarCercanos(lat, lon);
        });
      } else {
        alert('Tu navegador no soporta geolocalizaci√≥n.');
      }
    }
    
function limpiarBusqueda() {
  document.getElementById('searchInput').value = "";
  document.getElementById('latInput').value = "";
  document.getElementById('lonInput').value = "";
  document.getElementById('result').innerHTML = "";
  document.getElementById('tabla-cercanos').innerHTML = "";
  markerLayer.clearLayers();
  if (document.getElementById("searchType").value === "ubicacion") {
    document.getElementById("botonBuscar").disabled = true;
  }
}
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
    function centrarEnMapa(lat, lon, placa, alimentador) {
      map.setView([lat, lon], 17);
      const popupText = `<b>${placa}</b><br>${lat}, ${lon}<br>${alimentador}<br>
        <a href='https://www.google.com/maps?q=${lat},${lon}' target='_blank'>üìç Ver en Google Maps</a>`;
      const marker = L.marker([lat, lon]).addTo(markerLayer);
      marker.bindPopup(popupText).openPopup();
    }
    
    function usarUbicacionActual() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          userLocation = [lat, lon];
          L.marker(userLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'})})
            .addTo(markerLayer).bindPopup('Tu ubicaci√≥n').openPopup();
          mostrarCercanos(lat, lon);
        });
      } else {
        alert('Tu navegador no soporta geolocalizaci√≥n.');
      }
    }
    
function limpiarBusqueda() {
  document.getElementById('searchInput').value = "";
  document.getElementById('latInput').value = "";
  document.getElementById('lonInput').value = "";
  document.getElementById('result').innerHTML = "";
  document.getElementById('tabla-cercanos').innerHTML = "";
  markerLayer.clearLayers();
  if (document.getElementById("searchType").value === "ubicacion") {
    document.getElementById("botonBuscar").disabled = true;
  }
}
</script>
  <script>
    let placas = [];
    let contratos = [];
    let userLocation = null;
    let map = L.map('map').setView([13.7, -89.2], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
    }).addTo(map);
    let markerLayer = L.layerGroup().addTo(map);

    async function cargarDatos() {
      const response = await fetch('data.xlsx');
      const data = await response.arrayBuffer();
      const workbook = XLSX.read(data);
      const placasSheet = XLSX.utils.sheet_to_json(workbook.Sheets['Placas']);
      const contratosSheet = XLSX.utils.sheet_to_json(workbook.Sheets['Contratos']);

      placas = placasSheet.map(row => ({
        placa: row['REFERENCIA'],
        lat: row['Latitud'],
        lon: row['Longitud'],
        alimentador: row['Alimentador']
      }));

      contratos = contratosSheet.map(row => ({
        contrato: row['Contrato'].toString().trim(),
        ds: row['Referencia'],
        alimentador: row['Alimentador'],
        lat: row['Latitud'],
        lon: row['Longuitud']
      }));
    }

    function mostrarOpcionesUbicacion() {
      const tipo = document.getElementById('searchType').value;
      const coordsDiv = document.getElementById('manualCoords');
      const inputField = document.getElementById('searchInput');
      if (tipo === 'ubicacion') {
        coordsDiv.style.display = 'inline-block';
        inputField.style.display = 'none';
      } else {
        coordsDiv.style.display = 'none';
        inputField.style.display = 'inline-block';
      }
    }

    function buscar() {
      const tipo = document.getElementById('searchType').value;
      const valor = document.getElementById('searchInput').value.trim().toLowerCase();
      markerLayer.clearLayers();
      document.getElementById('result').innerHTML = '';

      if (tipo === 'placa') {
        const item = placas.find(p => p.placa.toLowerCase().trim() === valor);
        if (item) mostrarResultado(item.placa, item.lat, item.lon, item.alimentador);
        else alert('No se encontr√≥ la placa.');

      } else if (tipo === 'contrato') {
        const item = contratos.find(c => c.contrato.toLowerCase().trim() === valor);
        if (item) mostrarResultado(item.ds, item.lat, item.lon, item.alimentador || 'N/D');
        else alert('No se encontr√≥ el contrato.');

      } else if (tipo === 'ubicacion') {
        const latManual = parseFloat(document.getElementById('latInput').value);
        const lonManual = parseFloat(document.getElementById('lonInput').value);

        if (!isNaN(latManual) && !isNaN(lonManual)) {
          userLocation = [latManual, lonManual];
          L.marker(userLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'})})
            .addTo(markerLayer).bindPopup('Ubicaci√≥n manual').openPopup();
          mostrarCercanos(latManual, lonManual);
        } else if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            userLocation = [lat, lon];
            L.marker(userLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'})})
              .addTo(markerLayer).bindPopup('Tu ubicaci√≥n').openPopup();
            mostrarCercanos(lat, lon);
          });
        } else {
          alert('Tu navegador no soporta geolocalizaci√≥n.');
        }
      }
    }

    function mostrarResultado(nombre, lat, lon, alimentador) {
      document.getElementById('result').innerHTML = `
        <strong>${nombre}</strong><br>
        Coordenadas: ${lat}, ${lon}<br>
        Alimentador: ${alimentador}
      `;
      const marker = L.marker([lat, lon]).addTo(markerLayer);
      const ruta = userLocation ? 
        `https://www.google.com/maps/dir/${userLocation[0]},${userLocation[1]}/${lat},${lon}/` :
        `https://www.google.com/maps?q=${lat},${lon}`;
      marker.bindPopup(`<b>${nombre}</b><br>${lat}, ${lon}<br>${alimentador}<br><a href='${ruta}' target='_blank'>‚û° Ver ruta en Google Maps</a>`).openPopup();
      map.setView([lat, lon], 16);
    }

    function mostrarCercanos(lat, lon) {
      const todos = [...placas];
      todos.forEach(p => {
        p.distancia = Math.sqrt((p.lat - lat) ** 2 + (p.lon - lon) ** 2);
      });
      const cercanos = todos.sort((a, b) => a.distancia - b.distancia).slice(0, 10);
      cercanos.forEach(p => {
        const marker = L.marker([p.lat, p.lon]).addTo(markerLayer);
        const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;
const waze = `https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`;
        marker.bindPopup(`<b>${p.placa}</b><br>${p.lat}, ${p.lon}<br>${p.alimentador}<br><a href='${gmaps}' target='_blank'>üìç Ver en Google Maps</a>`);
      });
      document.getElementById('result').innerHTML = `
        Ubicaci√≥n actual: ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>
        
      `;

      let tablaHTML = "<table border='1' cellpadding='6' style='border-collapse:collapse; width:auto; text-align:left;'>";
      tablaHTML += "<thead><tr><th>Elemento</th><th>Alimentador</th><th>Distancia (m)</th><th>Mapa</th></tr></thead><tbody>";
      cercanos.forEach(p => {
        const distanciaM = (p.distancia * 111139).toFixed(1);
        const idFila = `punto_${p.lat}_${p.lon}`.replace(/\./g, '_');
        const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;
const waze = `https://waze.com/ul?ll=${p.lat},${p.lon}&navigate=yes`;
tablaHTML += `<tr><td><a href='#' onclick='event.preventDefault(); centrarEnMapa(${p.lat}, ${p.lon}, "${p.placa}", "${p.alimentador}")'>${p.placa}</a></td><td>${p.alimentador}</td><td>${distanciaM}</td><td><a href="${gmaps}" target="_blank">Maps</a> | <a href="${waze}" target="_blank">Waze</a></td></tr>`;
      });
      tablaHTML += "</tbody></table>";
      document.getElementById('tabla-cercanos').innerHTML = "<strong>10 elementos m√°s cercanos</strong><br><br>" + tablaHTML;
      map.setView([lat, lon], 14);
    }

    cargarDatos();
    mostrarOpcionesUbicacion();
  
    function centrarEnMapa(lat, lon, placa, alimentador) {
      map.setView([lat, lon], 17);
      const popupText = `<b>${placa}</b><br>${lat}, ${lon}<br>${alimentador}<br>
        <a href='https://www.google.com/maps?q=${lat},${lon}' target='_blank'>üìç Ver en Google Maps</a>`;
      const marker = L.marker([lat, lon]).addTo(markerLayer);
      marker.bindPopup(popupText).openPopup();
    }
    
    function usarUbicacionActual() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          userLocation = [lat, lon];
          L.marker(userLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'})})
            .addTo(markerLayer).bindPopup('Tu ubicaci√≥n').openPopup();
          mostrarCercanos(lat, lon);
        });
      } else {
        alert('Tu navegador no soporta geolocalizaci√≥n.');
      }
    }
    
function limpiarBusqueda() {
  document.getElementById('searchInput').value = "";
  document.getElementById('latInput').value = "";
  document.getElementById('lonInput').value = "";
  document.getElementById('result').innerHTML = "";
  document.getElementById('tabla-cercanos').innerHTML = "";
  markerLayer.clearLayers();
  if (document.getElementById("searchType").value === "ubicacion") {
    document.getElementById("botonBuscar").disabled = true;
  }
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tipoBusqueda = document.getElementById("searchType");
  const latInput = document.getElementById("latInput");
  const lonInput = document.getElementById("lonInput");
  const mensaje = document.getElementById("mensajeCoordenadas");

  function actualizarMensaje() {
    if (tipoBusqueda.value === "ubicacion") {
      const latValido = !isNaN(parseFloat(latInput.value));
      const lonValido = !isNaN(parseFloat(lonInput.value));
      mensaje.style.display = latValido && lonValido ? "none" : "block";
    } else {
      mensaje.style.display = "none";
    }
  }

  tipoBusqueda.addEventListener("change", actualizarMensaje);
  latInput.addEventListener("input", actualizarMensaje);
  lonInput.addEventListener("input", actualizarMensaje);
  actualizarMensaje();
});

function limpiarBusqueda() {
  document.getElementById('searchInput').value = "";
  document.getElementById('latInput').value = "";
  document.getElementById('lonInput').value = "";
  document.getElementById('result').innerHTML = "";
  document.getElementById('tabla-cercanos').innerHTML = "";
  markerLayer.clearLayers();
  if (document.getElementById("searchType").value === "ubicacion") {
    document.getElementById("botonBuscar").disabled = true;
  }
}
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const tipoBusqueda = document.getElementById("searchType");
  const latInput = document.getElementById("latInput");
  const lonInput = document.getElementById("lonInput");
  const botonBuscar = document.getElementById("botonBuscar");
  const mensaje = document.getElementById("mensajeCoordenadas");

  function validarCoordenadas() {
    if (tipoBusqueda.value === "ubicacion") {
      const latValido = !isNaN(parseFloat(latInput.value));
      const lonValido = !isNaN(parseFloat(lonInput.value));
      const valido = latValido && lonValido;
      botonBuscar.disabled = !valido;
      mensaje.style.display = valido ? "none" : "block";
    } else {
      botonBuscar.disabled = false;
      mensaje.style.display = "none";
    }
  }

  tipoBusqueda.addEventListener("change", validarCoordenadas);
  latInput.addEventListener("input", validarCoordenadas);
  lonInput.addEventListener("input", validarCoordenadas);
  validarCoordenadas();
});

function limpiarBusqueda() {
  document.getElementById('searchInput').value = "";
  document.getElementById('latInput').value = "";
  document.getElementById('lonInput').value = "";
  document.getElementById('result').innerHTML = "";
  document.getElementById('tabla-cercanos').innerHTML = "";
  markerLayer.clearLayers();
  if (document.getElementById("searchType").value === "ubicacion") {
    document.getElementById("botonBuscar").disabled = true;
  }
}
</script>

</body>
</html>
